<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%- include('../templates/css_includes', {}) %>
    <link rel="stylesheet" type="text/css" href="/source/chartjs/css/Chart.min.css">
        <title>Create KPI Profile</title>
</head>

<body>
    <%- include('../templates/js_includes', {}) %>
    <script type="text/javascript" src="/source/chartjs/js/Chart.min.js"></script>

        <!-- widgets -->
        <script type="text/javascript" src="/source/widgets/test_ui_element.js"></script>
        <script type="text/javascript" src="/source/widgets/activeStores_KPI.js"></script>
        <script type="text/javascript" src="/source/widgets/averageInventoryAmount_KPI.js"></script>
        <script type="text/javascript" src="/source/widgets/inventoryTurnover_KPI.js"></script>
        <style>
            body,
            html {
                height: 100%;
            }

            #main_cont {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: row;
            }

            #main_cont #tool_box {
                width: 124px;
                background-color: #11161ace;
                padding: 10px;
                display: flex;
                flex-direction: column;
                flex-wrap: wrap;
                overflow-y: scroll;
            }

            #main_cont #kpi_canvas {
                flex-grow: 1;
                position: relative;
            }

            .tool_box_row {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
            }

            .kpi_card {
                width: 72px;
                height: 72px;
                border: #bdbdbd 1px solid;
                border-radius: 12px;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                justify-content: end;
                align-items: center;
                transition: 0.5s ease;
                margin: 8px;
            }

            .kpi_card i {
                font-size: 32px;
                color: #e0e0e0;
                transition: 0.5s ease;
                margin-top: 10px;
            }

            .kpi_card p {
                color: #e0e0e0;
                transition: 0.5s ease;
            }

            .kpi_card:hover {
                color: #55c9e0;
                border: #55c9e0 1px solid;
            }

            .kpi_card:hover i {
                color: #55c9e0;
            }

            .kpi_card:hover p {
                color: #55c9e0;
            }
        </style>

        <div id="main_cont">
            <div id="tool_box">
            </div>
            <div id="kpi_canvas" ondragover="allow_drop(event);" ondrop="drop_action(event);">
            </div>
        </div>

        <script>
            // runtime vars
            let dragged_index = 0;
            let dummy_index = 0;

            let kpi_profile = {
                kpis: []
            };

            const kpi_ui_elements = [
                {
                    name: 'Stores',
                    object: 'activeStores_KPI',
                    icon: 'fas fa-plus',
                    kpi_params: {
                        chart_id: `"chart_${dummy_index}"`,
                        y_labels: '["A", "B", "C"]',
                        x_data: '[10, 20, 30]',
                        chart_label: '"test_label"',
                        flag: true,
                        comment: 'test_comment',
                        activeStoresNo: '10'
                    }
                },
                {
                    name: 'INV',
                    object: 'averageInventoryAmount_KPI',
                    icon: 'fas fa-plus'
                },
                {
                    name: 'Turn',
                    object: 'inventoryTurnover_KPI',
                    icon: 'fas fa-plus'
                },
                {
                    name: 'Test',
                    object: 'test_ui_element',
                    icon: 'fas fa-plus'
                }
            ];

            function get_kpi_card(kpi_name, kpi_icon, item_index) {
                return `
                <div class="kpi_card" draggable="true" ondragstart="drag_action(event, ${item_index});">
                        <i class="${kpi_icon}"></i>
                        <p>${kpi_name}</p>
                </div>
                `;
            }

            function get_view(widget_name, args_json) {
                return eval(`${widget_name}.get_view(${JSON.stringify(args_json)})`);
            }

            function allow_drop(event) {
                event.preventDefault();
            }

            function drop_action(event) {
                event.preventDefault();
                const kpi_cont_css = `
                position: absolute;
                width: fit-content;
                height: fit-content;
                padding: 8px;
                border-radius: 12px;
                top: ${event.pageY - 100}px;
                left: ${event.pageX - 124 - 200}px;
                border: #bdbdbd 1px solid;
                `;
                // update kpi state
                if (true) // debug note
                    kpi_ui_elements[dragged_index]['kpi_params'].chart_id = `"chart_${dummy_index}"`;
                const new_kpi_html = `
                <div id="kpi_cont" style="${kpi_cont_css}">${get_view(kpi_ui_elements[dragged_index]['object'], JSON.stringify(kpi_ui_elements[dragged_index]['kpi_params']))}</div>
                `;
                $('#kpi_canvas').html($('#kpi_canvas').html() + new_kpi_html);
                dummy_index++;
            }

            function drag_action(event, item_index) {
                dragged_index = item_index;
            }

            $(document).ready(() => {
                let kpi_tool_box_html = '';
                for (let i = 0; i < kpi_ui_elements.length; i++) {
                    const x = kpi_ui_elements[i]
                    kpi_tool_box_html += get_kpi_card(x['name'], x['icon'], i);
                    kpi_tool_box_html += '<br>'
                }
                $('#tool_box').html(kpi_tool_box_html);
            });
        </script>
</body>

</html>